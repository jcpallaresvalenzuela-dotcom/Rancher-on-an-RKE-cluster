Este documento describe el paso a paso para hacer el un deploy de Rancher sobre un cluster RKE

El Cluster estÃ¡ conformado por 3 vms [1 Manager 2 Workers]

*DESHABILITAR LA MEMORIA SWAP EN LOS NODOS
(Para que k8s identifique que no tiene mas memoria y schedulee los workloads en otro lado)

1- Install Docker in the vms
    https://docs.docker.com/engine/install/ubuntu/

        apt-get update

        apt-get install \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
        $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

        apt-get update
        apt-get install docker-ce docker-ce-cli containerd.io

2- Test connectivity between virtual and connection

        ping [IPADDRES] between the vms workers & managers

        Copy keys in /root/.ssh

        Give permissions to the ssh folder
        chmod 40 ~/.ssh/0

3- Chequear pre-requisitos de vm 
    https://rancher.com/docs/rancher/v2.6/en/installation/requirements/

4- RKE Requirements


    The following sysctl setting must be applied in all nodes

        sysctl net.bridge.bridge-nf-call-iptables=1

5- Install kubectl
    https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/

6- Install Helm
    https://helm.sh/docs/introhelm/install/

7- Install RKE
    https://rancher.com/docs/rke/latest/en/installation/

    - Download the RKE binary:
        https://github.com/rancher/rke/releases/ (v1.3.4 latest version)

    - Copy the RKE binary to a folder in your $PATH and rename it rke

    - Dar permisos de ejecucion
        chmod +x rke

    - Confirmar que el archivo es ejecutable
        rke --version

8- Create the Cluster Configuration File
    https://rancher.com/docs/rke/latest/en/installation/

    rke config

    OR

    rke config --name cluster.yml

9- Deploying Kubernetes with RKE
    
    rke up

    *The last line should read Finished building Kubernetes cluster successfully to indicate that your cluster is ready to use. 
    As part of the Kubernetes creation process, a kubeconfig file has been created and written at kube_config_cluster.yml, 
    which can be used to start interacting with your Kubernetes cluster.

10- Export the RKE configuration file generated by doing 'rke up'
    https://rancher.com/docs/rancher/v2.6/en/installation/resources/k8s-tutorials/ha-rke/
    
    export KUBECONFIG=./kube_config_cluster.yml

    You can also use this yml file to conect to the Kubernetes API Server to manage it from a remote location

11- Add the Helm Chart Repository 
    https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/

        helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
    
12- Create a Namespace for Rancher
        
        kubectl create namespace cattle-system

13- Install cert-manager
    https://rancher.com/docs/rancher/v2.6/en/installation/install-rancher-on-k8s/

        # If you have installed the CRDs manually instead of with the `--set installCRDs=true` option added to your Helm install command, you should upgrade your CRD resources before upgrading the Helm chart:
        
            1- kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.5.1/cert-manager.crds.yaml

        # Add the Jetstack Helm repository
            2 - helm repo add jetstack https://charts.jetstack.io

        # Update your local Helm chart repository cache
            3 - helm repo update

        # Install the cert-manager Helm chart
            4 - helm install cert-manager jetstack/cert-manager \
                --namespace cert-manager \
                --create-namespace \
                --version v1.5.1
        
        # Verify it is deployed correctly

            kubectl get pods --namespace cert-manager

14- Install Rancher with Helm

    helm install rancher rancher-stable/rancher \
  --namespace cattle-system \
  --set hostname=testcluster.local \
  --set bootstrapPassword=admin

15- Verify that the Rancher Server is Successfully Deployed

    kubectl -n cattle-system rollout status deploy/rancher

    kubectl -n cattle-system get deploy rancher

16- Access to the RANCHER UI

    # Make sure to define the public IP address with the hostname defined in Rancher in /etc/hosts 
      and open ports 80 - 443 so that rancher can publish

    In your browser go to: https://[hostname set in rancher installation]


Versions:
Docker client engine: 20.10.12
Docker server engine: 20.10.12
Kubectl client: 1.23
kubectl server: 1.21
RKE: 1.3.4 
Rancher: 2.6 
Helm: 3.7.2 
cert-manager: 1.5.1

2022

